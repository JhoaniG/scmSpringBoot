<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Lista de Diagnósticos</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link th:href="@{/css/stilos.css}" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
</head>
<body>

<div th:replace="fragments/menuV :: menuV"></div>
<input type="checkbox" id="btn-menu">

<div th:replace="fragments/barralateralV :: barralateralV"></div>

<div class="container mt-5">
    <h2 class="text-center mb-4 text-primary">Diagnósticos de Dueños</h2>

    <div th:if="${mensajeExito}" class="alert alert-success alert-dismissible fade show" role="alert">
        <span th:text="${mensajeExito}"></span>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
    <div th:if="${mensajeError}" class="alert alert-danger alert-dismissible fade show" role="alert">
        <span th:text="${mensajeError}"></span>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>

    <div style="max-height: 500px; overflow-y: auto; border: 1px solid #dee2e6; border-radius: .25rem;" class="shadow-sm">
        <div class="table-responsive">
            <table class="table table-striped table-hover border-primary mb-0">
                <thead class="table-dark text-center" style="position: sticky; top: 0; z-index: 1;">
                <tr>
                    <th>ID Diagnóstico</th>
                    <th>Mascota</th>
                    <th>Dueño</th>
                    <th>Fecha</th>
                    <th>Observaciones</th>
                    <th>Tipo de enfermedad</th>
                    <th>Acciones</th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="d : ${listaDiagnosticos}" class="text-center">
                    <td th:text="${d.idDiagnosticoDueno}"></td>
                    <td th:text="${d.nombreM}"></td>
                    <td th:text="${d.nombreDueno}"></td>
                    <td th:text="${d.fechaDiagnostico}"></td>
                    <td th:text="${d.observaciones}"></td>
                    <td th:text="${d.tipoEnfermedad}"></td>
                    <td>
                        <button class="btn btn-sm btn-primary"
                                data-bs-toggle="modal"
                                data-bs-target="#citaModal"
                                th:attr="data-iddiagnostico=${d.idDiagnosticoDueno},
                                         data-idmascota=${d.mascotaId},
                                         data-tipoenfermedad=${d.tipoEnfermedad}">
                            Agendar Cita
                        </button>
                    </td>
                </tr>
                </tbody>
            </table>
        </div>
    </div>
    <div class="alert alert-info mt-4" role="alert">
        <h5 class="alert-heading"><i class="fas fa-info-circle"></i> Recordatorio</h5>
        <p class="mb-0">Recuerda que al registrar una cita y haberla efectuado, debes marcarla como <strong>"Terminada"</strong> en la lista de citas para poder registrar nuevas dietas o actividades.</p>
    </div>

    <div class="text-center mt-4">
        <a th:href="@{/citas}" class="btn btn-primary">
            <i class="fas fa-calendar-alt me-1"></i> Ir a Citas
        </a>
        <a th:href="@{/veterinario/index}" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left me-1"></i> Volver al Panel
        </a>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"></script>


<div class="modal fade" id="citaModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <form th:action="@{/citas/crear}" th:object="${citaDTO}" method="post" class="needs-validation" novalidate>

                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">Crear Cita</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                </div>

                <div class="modal-body">
                    <input type="hidden" th:field="*{diagnosticoduenoId}" id="modalIdD">
                    <input type="hidden" th:field="*{mascotaId}" id="modalIdMascota">
                    <input type="hidden" th:field="*{veterinarioId}" th:value="${session.veterinarioId}">

                    <div class="mb-3">
                        <label for="FechaCita" class="form-label">Fecha de la Cita</label>
                        <input type="date" th:field="*{fecha}" id="FechaCita" class="form-control" required>
                        <div class="invalid-feedback">
                            Por favor, seleccione una fecha de cita válida (hoy o futura).
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="HoraCita" class="form-label">Hora de la Cita</LabeL>
                        <select th:field="*{hora}" id="HoraCita" class="form-select" required>
                            <option value="" disabled selected>Seleccione una franja horaria</option>
                            <option value="09:00:00">09:00 AM</option>
                            <option value="10:00:00">10:00 AM</option>
                            <option value="11:00:00">11:00 AM</option>
                            <option value="13:00:00">01:00 PM</option>
                            <option value="14:00:00">02:00 PM</option>
                            <option value="15:00:00">03:00 PM</option>
                            <option value="16:00:00">04:00 PM</option>
                        </select>
                        <div class="invalid-feedback">
                            Por favor, seleccione una hora.
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="MotivoCita" class="form-label">Motivo</label>
                        <input type="text" th:field="*{motivoCita}" id="MotivoCita" class="form-control"
                               required minlength="5" maxlength="255"
                               title="El motivo de la cita debe tener entre 5 y 255 caracteres.">
                        <div class="invalid-feedback">
                            Por favor, ingrese un motivo para la cita (entre 5 y 255 caracteres).
                        </div>
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="submit" class="btn btn-success">Guardar</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script th:inline="javascript">
    document.addEventListener('DOMContentLoaded', function () {
        const citaModal = document.getElementById('citaModal');
        const fechaCitaInput = document.getElementById('FechaCita');
        const motivoCitaInput = document.getElementById('MotivoCita');

        // --- 1. Configuración de Fecha Mínima ---
        const today = new Date();
        const year = today.getFullYear();
        const month = (today.getMonth() + 1).toString().padStart(2, '0');
        const day = today.getDate().toString().padStart(2, '0');
        const minDate = `${year}-${month}-${day}`;
        fechaCitaInput.setAttribute('min', minDate);

        // --- 2. Evento para poblar el Modal ---
        citaModal.addEventListener('show.bs.modal', function (ev) {
            const btn = ev.relatedTarget;
            if (!btn) return;

            const idD = btn.getAttribute('data-iddiagnostico');
            const idMascota = btn.getAttribute('data-idmascota');
            const tipoEnfermedad = btn.getAttribute('data-tipoenfermedad');

            document.getElementById('modalIdD').value = idD;
            document.getElementById('modalIdMascota').value = idMascota;
            motivoCitaInput.value = tipoEnfermedad;

            const form = citaModal.querySelector('.needs-validation');
            form.classList.remove('was-validated');
            Array.from(form.elements).forEach(el => {
                el.classList.remove('is-valid', 'is-invalid');
                el.setCustomValidity("");
            });

            document.getElementById('HoraCita').value = "";
            fechaCitaInput.value = minDate;
        });

        // --- 3. Validación de Bootstrap ---
        const form = citaModal.querySelector('.needs-validation');
        form.addEventListener('submit', function(event) {
            const selectedDate = new Date(fechaCitaInput.value);
            const currentDate = new Date();
            selectedDate.setHours(0,0,0,0);
            currentDate.setHours(0,0,0,0);

            if (selectedDate < currentDate) {
                fechaCitaInput.setCustomValidity("La fecha no puede ser pasada.");
            } else {
                fechaCitaInput.setCustomValidity("");
            }

            if (!form.checkValidity()) {
                event.preventDefault();
                event.stopPropagation();
            }
            form.classList.add('was-validated');
        });

        fechaCitaInput.addEventListener('input', () => fechaCitaInput.setCustomValidity(""));
    });
</script>
</body>
</html>