<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Diagnósticos Recientes</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" th:href="@{/css/stilos.css}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <style>
        body { background-color: #f4f6f9; min-height: 100vh; }
        .content-wrapper { padding-top: 80px; padding-bottom: 50px; }
        .page-header { background: linear-gradient(135deg, #0d6efd 0%, #0dcaf0 100%); color: white; border-radius: 15px; padding: 2rem; margin-bottom: 2rem; text-align: center; }
        .search-box { background: white; padding: 1.5rem; border-radius: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); margin-bottom: 2rem; }
        .table-card { background: white; border-radius: 15px; overflow: hidden; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        .table thead { background-color: #343a40; color: white; }
        .pagination .page-link { color: #0d6efd; border-radius: 50%; margin: 0 3px; width: 35px; height: 35px; display: flex; align-items: center; justify-content: center; border: none; }
        .pagination .page-item.active .page-link { background-color: #0d6efd; color: white; }
        .badge-alta { background-color: #dc3545; } .badge-media { background-color: #ffc107; color: #000; } .badge-baja { background-color: #198754; }
    </style>
</head>
<body>

<div th:replace="fragments/menuV :: menuV"></div>
<input type="checkbox" id="btn-menu">
<div th:replace="fragments/barralateralV :: barralateralV"></div>
<span id="logged-in-vet-id" th:data-vet-id="${veterinarioIdLogueado}" style="display: none;"></span>

<div class="content-wrapper container mt-5">

    <div class="page-header">
        <h2 class="fw-bold mb-2"><i class="fas fa-stethoscope me-2"></i>Diagnósticos Recientes</h2>
        <p class="mb-0 opacity-90">Revisa los reportes, filtra por paciente y agenda citas.</p>
    </div>

    <div th:if="${mensajeExito}" class="alert alert-success alert-dismissible fade show" role="alert">
        <span th:text="${mensajeExito}"></span><button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
    <div th:if="${mensajeError}" class="alert alert-danger alert-dismissible fade show" role="alert">
        <span th:text="${mensajeError}"></span><button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>

    <div class="search-box">
        <form th:action="@{/diagnosticos/listar}" method="GET" class="d-flex gap-2">
            <input class="form-control rounded-pill" type="search" placeholder="Buscar por mascota, dueño o síntoma..." name="filtro" th:value="${filtro}">
            <button class="btn btn-primary rounded-pill px-4" type="submit">Buscar</button>
            <a th:href="@{/diagnosticos/listar}" class="btn btn-outline-secondary rounded-circle"><i class="fas fa-times"></i></a>
        </form>
    </div>

    <div class="table-card">
        <div class="table-responsive">
            <table class="table table-hover mb-0 align-middle">
                <thead class="text-center">
                <tr>
                    <th>ID</th>
                    <th>Paciente</th>
                    <th>Dueño</th>
                    <th>Fecha</th>
                    <th>Observaciones</th>
                    <th>Tipo</th>
                    <th>Prioridad</th>
                    <th>Acción</th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="d : ${diagnosticosPage.content}" class="text-center">
                    <td class="text-muted" th:text="${d.idDiagnosticoDueno}"></td>
                    <td class="fw-bold text-primary" th:text="${d.nombreM}"></td>
                    <td th:text="${d.nombreDueno}"></td>
                    <td th:text="${d.fechaDiagnostico}"></td>
                    <td><span class="d-inline-block text-truncate" style="max-width: 150px;" th:text="${d.observaciones}" th:title="${d.observaciones}"></span></td>
                    <td><span class="badge bg-info text-dark" th:text="${d.tipoEnfermedad}"></span></td>

                    <td>
                        <span class="badge"
                              th:classappend="${d.prioridad == 'Alta'} ? 'badge-alta' : (${d.prioridad == 'Media'} ? 'badge-media' : 'badge-baja')"
                              th:text="${d.prioridad ?: 'Normal'}"></span>
                    </td>

                    <td>
                        <span th:if="${d.citaAgendada}" class="badge bg-success"><i class="fas fa-check me-1"></i> Agendada</span>
                        <button th:unless="${d.citaAgendada}" class="btn btn-primary btn-sm rounded-pill px-3"
                                data-bs-toggle="modal" data-bs-target="#citaModal"
                                th:attr="data-iddiagnostico=${d.idDiagnosticoDueno}, data-idmascota=${d.mascotaId}, data-tipoenfermedad=${d.tipoEnfermedad}">
                            <i class="fas fa-calendar-plus"></i> Agendar
                        </button>
                    </td>
                </tr>
                <tr th:if="${diagnosticosPage.empty}">
                    <td colspan="8" class="text-center py-5 text-muted">No se encontraron resultados.</td>
                </tr>
                </tbody>
            </table>
        </div>
    </div>

    <nav aria-label="Paginacion" th:if="${diagnosticosPage.totalPages > 0}" class="mt-4">
        <ul class="pagination justify-content-center">
            <li class="page-item" th:classappend="${diagnosticosPage.first} ? 'disabled'">
                <a class="page-link" th:href="@{/diagnosticos/listar(filtro=${filtro}, page=${diagnosticosPage.number - 1})}"><i class="fas fa-chevron-left"></i></a>
            </li>

            <li class="page-item" th:each="i : ${#numbers.sequence(0, diagnosticosPage.totalPages - 1)}"
                th:classappend="${i == diagnosticosPage.number} ? 'active'">
                <a class="page-link" th:href="@{/diagnosticos/listar(filtro=${filtro}, page=${i})}" th:text="${i + 1}">1</a>
            </li>

            <li class="page-item" th:classappend="${diagnosticosPage.last} ? 'disabled'">
                <a class="page-link" th:href="@{/diagnosticos/listar(filtro=${filtro}, page=${diagnosticosPage.number + 1})}"><i class="fas fa-chevron-right"></i></a>
            </li>
        </ul>
    </nav>

    <div class="text-center mt-4 mb-5">
        <a th:href="@{/veterinario/index}" class="btn btn-outline-secondary rounded-pill px-4">Volver al Panel</a>
    </div>
</div>

<div class="modal fade" id="citaModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow">
            <form th:action="@{/citas/crear}" th:object="${citaDTO}" method="post" class="needs-validation" novalidate>
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">Agendar Cita</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" th:field="*{diagnosticoduenoId}" id="modalIdD">
                    <input type="hidden" th:field="*{mascotaId}" id="modalIdMascota">
                    <div class="mb-3"><label class="form-label small fw-bold">Fecha</label><input type="date" th:field="*{fecha}" id="FechaCita" class="form-control" required></div>
                    <div class="mb-3"><label class="form-label small fw-bold">Hora</label>
                        <select th:field="*{hora}" id="HoraCita" class="form-select" required>
                            <option value="" disabled selected>Seleccionar...</option>
                            <option value="08:00:00">08:00 AM</option><option value="09:00:00">09:00 AM</option><option value="10:00:00">10:00 AM</option>
                            <option value="14:00:00">02:00 PM</option><option value="15:00:00">03:00 PM</option><option value="16:00:00">04:00 PM</option>
                        </select>
                    </div>
                    <div class="mb-3"><label class="form-label small fw-bold">Motivo</label><input type="text" th:field="*{motivoCita}" id="MotivoCita" class="form-control" required></div>
                </div>
                <div class="modal-footer"><button type="submit" class="btn btn-primary">Guardar</button></div>
            </form>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const citaModal = document.getElementById('citaModal');
        const fechaInput = document.getElementById('FechaCita');
        const motivoInput = document.getElementById('MotivoCita');
        const today = new Date().toISOString().split('T')[0];
        fechaInput.setAttribute('min', today);

        citaModal.addEventListener('show.bs.modal', function (ev) {
            const btn = ev.relatedTarget;
            document.getElementById('modalIdD').value = btn.getAttribute('data-iddiagnostico');
            document.getElementById('modalIdMascota').value = btn.getAttribute('data-idmascota');

            const tipo = btn.getAttribute('data-tipoenfermedad');
            if(tipo) motivoInput.value = "Atención: " + tipo;

            fechaInput.value = today;
        });
    });
</script>
</body>
</html>