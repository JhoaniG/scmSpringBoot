<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registrar Mascota - SCM</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" th:href="@{/css/stilos.css}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">

    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" />

    <style>
        body { background-color: #f4f6f9; min-height: 100vh; }

        .content-wrapper {
            padding-top: 90px;
            padding-bottom: 50px;
            transition: margin-left 0.3s;
        }
        @media (min-width: 992px) { .content-wrapper { margin-left: 250px; } }

        /* Tarjeta del Formulario */
        .form-card {
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(111, 66, 193, 0.1); /* Sombra morada */
            overflow: hidden;
            max-width: 800px;
            margin: 0 auto;
            border: none;
        }

        .card-header-custom {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); /* Morado Dueño */
            color: white;
            padding: 2.5rem 2rem;
            text-align: center;
            position: relative;
        }
        .header-icon { font-size: 3rem; margin-bottom: 0.5rem; opacity: 0.9; }
        .header-title { font-weight: 800; letter-spacing: 0.5px; margin: 0; }

        .card-body-custom { padding: 3rem; }

        /* Estilos de Inputs */
        .form-label { font-weight: 700; color: #555; font-size: 0.9rem; margin-bottom: 0.5rem; }
        .form-control, .form-select {
            border-radius: 10px; padding: 0.8rem 1rem; border: 1px solid #e0e0e0;
            background-color: #fdfdfd; transition: all 0.2s;
        }
        .form-control:focus, .form-select:focus {
            border-color: #6f42c1; box-shadow: 0 0 0 0.25rem rgba(111, 66, 193, 0.15);
        }

        /* Radio Buttons Estilizados */
        .radio-card {
            border: 1px solid #e0e0e0; border-radius: 10px; padding: 1rem;
            margin-bottom: 1rem; cursor: pointer; transition: all 0.2s;
            display: flex; align-items: center;
        }
        .radio-card:hover { background-color: #f8f9fa; }
        .form-check-input:checked + .form-check-label { color: #6f42c1; font-weight: bold; }
        .form-check-input:checked ~ .radio-card { border-color: #6f42c1; background-color: #f3e5f5; }

        /* Botones */
        .btn-save {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none; color: white; padding: 12px 35px;
            border-radius: 50px; font-weight: 700; transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(111, 66, 193, 0.3);
        }
        .btn-save:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(111, 66, 193, 0.5); color: white;}

        .btn-back {
            border: 2px solid #dee2e6; color: #6c757d; font-weight: 600; border-radius: 50px;
            padding: 10px 25px; text-decoration: none; transition: 0.3s; background: white;
        }
        .btn-back:hover { background-color: #e9ecef; color: #333; }

        .select2-container--bootstrap-5 .select2-selection { border-radius: 10px; padding: 0.5rem; }
    </style>
</head>
<body>

<div th:replace="~{fragments/menuV :: menuV}"></div>
<input type="checkbox" id="btn-menu">
<div th:replace="~{fragments/barralateralD :: barralateralD(${diagnosticoDTO}, ${mascotas}, ${veterinarios}, ${usuario})}"></div>
<div th:replace="~{fragments/barralateralD :: modalDiagnostico(${diagnosticoDTO}, ${mascotas}, ${veterinarios})}"></div>

<div class="content-wrapper">
    <div class="container">

        <div class="form-card">
            <div class="card-header-custom">
                <div class="header-icon"><i class="fas fa-paw"></i></div>
                <h2 class="header-title">Registrar Nueva Mascota</h2>
                <p class="mb-0 opacity-75">Añade un nuevo miembro a tu familia</p>
            </div>

            <div class="card-body-custom">

                <div th:if="${error}" class="alert alert-danger alert-dismissible fade show shadow-sm rounded-3 mb-4" role="alert">
                    <i class="fas fa-exclamation-circle me-2"></i> <span th:text="${error}"></span>
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>

                <form th:action="@{/mascotas/crear}" th:object="${mascotaDTO}" method="post"
                      enctype="multipart/form-data" class="needs-validation" novalidate>

                    <!-- Nombre -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <label for="nombre" class="form-label">Nombre de la Mascota *</label>
                            <div class="input-group">
                                <span class="input-group-text bg-white border-end-0 rounded-start-3">
                                    <i class="fas fa-signature text-primary"></i></span>
                                <input type="text" th:field="*{nombre}" id="nombre" class="form-control border-start-0"
                                       placeholder="Ej: Max" required minlength="2" maxlength="50"
                                       pattern="[a-zA-ZáéíóúÁÉÍÓÚñÑ\s]+">
                                <div class="invalid-feedback">Obligatorio. Solo letras (2-50 caracteres).</div>
                            </div>
                        </div>

                        <!-- Género -->
                        <div class="col-md-6 mt-3 mt-md-0">
                            <label for="genero" class="form-label">Género *</label>
                            <div class="input-group">
                                <span class="input-group-text bg-white border-end-0 rounded-start-3">
                                    <i class="fas fa-venus-mars text-danger"></i></span>
                                <select th:field="*{genero}" id="genero" class="form-select border-start-0" required>
                                    <option value="" disabled selected>Selecciona</option>
                                    <option value="Macho">Macho</option>
                                    <option value="Hembra">Hembra</option>
                                </select>
                                <div class="invalid-feedback">Selecciona una opción.</div>
                            </div>
                        </div>
                    </div>

                    <!-- Adopción -->
                    <div class="mb-4 p-3 bg-light rounded-3 border">
                        <label class="form-label mb-3 d-block">¿Conoces la fecha de nacimiento? *</label>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-check radio-card bg-white">
                                    <input class="form-check-input me-2" type="radio" th:field="*{esAdoptado}"
                                           id="adoptadoNo" value="false" checked required>
                                    <label class="form-check-label w-100" for="adoptadoNo">Sí, la conozco</label>
                                </div>
                            </div>

                            <div class="col-md-6">
                                <div class="form-check radio-card bg-white">
                                    <input class="form-check-input me-2" type="radio" th:field="*{esAdoptado}"
                                           id="adoptadoSi" value="true" required>
                                    <label class="form-check-label w-100" for="adoptadoSi">
                                        No, es adoptado (edad aprox)
                                    </label>
                                </div>
                            </div>
                        </div>

                        <!-- Fecha de nacimiento -->
                        <div class="mt-3" id="campoFechaNacimiento">
                            <label for="fechaNacimiento" class="form-label">Fecha de Nacimiento *</label>
                            <input type="date" th:field="*{fechaNacimiento}" id="fechaNacimiento"
                                   class="form-control" required>
                            <div class="invalid-feedback">Selecciona una fecha válida.</div>
                        </div>

                        <!-- Edad estimada -->
                        <div class="mt-3" id="campoEdadEstimada" style="display: none;">
                            <label for="edadEstimadaAnios" class="form-label">Edad Estimada (Años) *</label>
                            <input type="number" th:field="*{edadEstimadaAnios}" id="edadEstimadaAnios"
                                   class="form-control" placeholder="Ej: 5" min="0" max="30">
                            <div class="invalid-feedback">Ingresa una edad válida (0-30).</div>
                        </div>
                    </div>

                    <!-- Especie y raza -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <label for="especie" class="form-label">Especie *</label>
                            <select class="form-control-select2" id="especie" th:field="*{especie}" required>
                                <option value="" disabled selected>Selecciona especie...</option>
                                <option value="Perro">Perro</option>
                                <option value="Gato">Gato</option>
                                <option value="Pájaro">Pájaro</option>
                                <option value="Conejo">Conejo</option>
                                <option value="Hámster">Hámster</option>
                                <option value="Pez">Pez</option>
                                <option value="Reptil">Reptil</option>
                                <option value="Otro">Otro</option>
                            </select>
                            <div class="invalid-feedback">Obligatorio.</div>
                        </div>

                        <div class="col-md-6 mt-3 mt-md-0">
                            <label for="raza" class="form-label">Raza *</label>
                            <select class="form-control-select2" id="raza" th:field="*{raza}" required>
                                <option value="" disabled selected>Selecciona especie primero...</option>
                            </select>
                            <div class="invalid-feedback">Obligatorio.</div>
                        </div>
                    </div>

                    <!-- Foto -->
                    <div class="mb-4">
                        <label for="archivoFoto" class="form-label">Foto de Perfil *</label>
                        <input type="file" th:field="*{archivoFoto}" id="archivoFoto"
                               class="form-control" accept="image/*" required>
                        <div class="invalid-feedback">Selecciona una foto.</div>
                    </div>

                    <!-- Botones -->
                    <div class="d-flex justify-content-between align-items-center mt-5">
                        <a th:href="@{/dueno/index}" class="btn-back">
                            <i class="fas fa-arrow-left me-2"></i> Cancelar
                        </a>
                        <button type="submit" class="btn-save">
                            <i class="fas fa-check me-2"></i> Registrar Mascota
                        </button>
                    </div>

                </form>
            </div>
        </div>

    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<script>
    const razasPorEspecie = {
        "Perro": ["Labrador Retriever", "Pastor Alemán", "Golden Retriever", "Bulldog", "Poodle (Caniche)", "Beagle", "Boxer", "Dachshund (Salchicha)", "Shih Tzu", "Schnauzer", "Yorkshire Terrier", "Chihuahua", "Pug", "Criollo (Mestizo)"],
        "Gato": ["Siamés", "Persa", "Maine Coon", "Ragdoll", "Bengalí", "Abisinio", "Birmano", "Esfinge (Sphynx)", "Criollo (Mestizo)"],
        "Pájaro": ["Canario", "Periquito", "Agapornis", "Ninfa (Carolina)", "Loro", "Cacatúa"],
        "Conejo": ["Rex", "Belier", "Cabeza de León", "Gigante de Flandes"],
        "Hámster": ["Sirio (Dorado)", "Ruso (Campbell)", "Roborovski"],
        "Pez": ["Goldfish", "Betta", "Guppy", "Tetra Neón"],
        "Reptil": ["Tortuga de orejas rojas", "Gecko Leopardo", "Dragón Barbudo", "Serpiente del maíz"],
        "Otro": ["No Aplica"]
    };

    $(document).ready(function() {
        $('.form-control-select2').select2({ theme: "bootstrap-5", width: '100%' });

        $('#especie').on('change', function() {
            const especie = $(this).val();
            const $raza = $('#raza');
            $raza.empty();
            $raza.append(new Option('No lo sé / Mestizo', 'No lo sé / Mestizo'));

            if (razasPorEspecie[especie]) {
                razasPorEspecie[especie].forEach(raza => $raza.append(new Option(raza, raza)));
            } else {
                $raza.append(new Option('No Aplica', 'No Aplica'));
            }
            $raza.val('No lo sé / Mestizo').trigger('change');
        });

        $('input[type=radio][name=esAdoptado]').change(function() {
            if (this.value === 'true') {
                $('#campoEdadEstimada').slideDown();
                $('#campoFechaNacimiento').slideUp();
                $('#fechaNacimiento').val('').prop('required', false);
                $('#edadEstimadaAnios').prop('required', true);
            } else {
                $('#campoEdadEstimada').slideUp();
                $('#campoFechaNacimiento').slideDown();
                $('#edadEstimadaAnios').val('').prop('required', false);
                $('#fechaNacimiento').prop('required', true);
            }
        });

        $('input[type=radio][name=esAdoptado]:checked').trigger('change');
    });

    document.addEventListener('DOMContentLoaded', function () {
        const form = document.querySelector('.needs-validation');
        const fechaInput = document.getElementById('fechaNacimiento');

        const today = new Date().toISOString().split('T')[0];
        fechaInput.setAttribute('max', today);

        form.addEventListener('submit', function (event) {
            const selectedDate = new Date(fechaInput.value);
            const currentDate = new Date();
            currentDate.setHours(0, 0, 0, 0);

            if ($('#campoFechaNacimiento').is(':visible') && fechaInput.value && selectedDate >= currentDate) {
                fechaInput.setCustomValidity("La fecha debe ser anterior a hoy.");
            } else {
                fechaInput.setCustomValidity("");
            }

            if (!form.checkValidity()) {
                event.preventDefault();
                event.stopPropagation();
            }

            form.classList.add('was-validated');
        });

        fechaInput.addEventListener('input', () => fechaInput.setCustomValidity(""));
    });
</script>

</body>
</html>
