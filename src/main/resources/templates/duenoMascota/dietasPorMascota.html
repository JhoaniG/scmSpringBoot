<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SCM - Consulta de Dieta</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" th:href="@{/css/stilos.css}">
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@5.10.1/main.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <style>
        .page-cards-container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            justify-content: center;
            margin-top: 30px;
        }
        .page-card {
            width: 300px;
            border: 1px solid #555; /* Borde m√°s sutil para fondo oscuro */
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            display: flex;
            flex-direction: column;
            background: #343a40; /* Fondo oscuro para que resalte el texto blanco */
            color: #ffffff; /* Texto blanco solicitado */
        }
        .page-card img {
            width: 100%;
            height: 200px;
            object-fit: cover;
        }
        .page-card-body {
            padding: 15px;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }
        /* Ajuste para los textos peque√±os dentro de la tarjeta oscura */
        .page-card-body .text-muted {
            color: #adb5bd !important; /* Gris claro para subt√≠tulos */
        }

        .mt-auto { margin-top: auto; }

        #dieta-calendar-instance {
            min-height: 400px;
            max-height: 60vh;
        }

        /* --- ESTILOS PARA LAS TERMINADAS --- */
        .card-finished {
            border: 2px solid #666;
            background-color: #495057; /* Un gris un poco m√°s claro para diferenciar */
            opacity: 0.95;
            color: #e0e0e0; /* Texto casi blanco */
        }
        .card-finished .page-card-body {
            color: #e0e0e0; /* Asegurar texto claro en historial */
        }
        .card-finished img {
            filter: grayscale(80%);
        }
        .badge-finished {
            position: absolute;
            top: 10px;
            right: 10px;
            background-color: #6c757d;
            color: white;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: bold;
        }

        /* Tu estilo para el bot√≥n azul */
        .btn-back-strong {
            background-color: #0d6efd; /* Azul brillante */
            color: #fff !important;
            font-size: 18px;
            font-weight: 600;
            padding: 12px 25px;
            border-radius: 10px;
            display: inline-block;
            text-decoration: none;
            transition: all 0.3s ease;
            box-shadow: 0 4px 10px rgba(0,0,0,0.15);
        }

        .btn-back-strong:hover {
            background-color: #084298; /* Azul m√°s oscuro */
            transform: translateY(-3px);
            box-shadow: 0 6px 14px rgba(0,0,0,0.25);
        }
    </style>
</head>
<body>

<div th:replace="~{fragments/menuV :: menuV}"></div>
<input type="checkbox" id="btn-menu">
<div th:replace="~{fragments/barralateralD :: barralateralD(${diagnosticoDTO}, ${mascotas}, ${veterinarios}, ${usuario})}"></div>
<div th:replace="~{fragments/barralateralD :: modalDiagnostico(${diagnosticoDTO}, ${mascotas}, ${veterinarios})}"></div>

<div class="container text-center mt-5">
    <h1 class="header-title">SCM - Plan de Alimentaci√≥n</h1>
    <p class="lead">Consulta la dieta recomendada para tu mascota</p>
</div>

<div class="container mt-3 text-center">
    <a th:href="@{/dueno/mascotas}" class="btn-back-strong">
        ‚Üê Volver a Mis Mascotas
    </a>
</div>

<div class="container mt-4">
    <ul class="nav nav-tabs justify-content-center" id="dietTab" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active fw-bold" id="activas-tab" data-bs-toggle="tab" data-bs-target="#activas" type="button" role="tab">
                <i class="fas fa-utensils text-success"></i> En Curso (Activas)
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link fw-bold text-secondary" id="historial-tab" data-bs-toggle="tab" data-bs-target="#historial" type="button" role="tab">
                <i class="fas fa-history"></i> Historial (Terminadas)
            </button>
        </li>
    </ul>
</div>

<div class="tab-content" id="dietTabContent">

    <div class="tab-pane fade show active" id="activas" role="tabpanel">
        <div class="page-cards-container">
            <div th:if="${#lists.isEmpty(dietas)}" class="alert alert-info w-50 text-center mt-4">
                No hay dietas activas actualmente.
            </div>

            <div th:unless="${#lists.isEmpty(dietas)}" th:each="d : ${dietas}" class="page-card">

                <img th:if="${d.foto != null}" th:src="@{/uploads/dietas/{foto}(foto=${d.foto})}" alt="Dieta">
                <img th:if="${d.foto == null}" th:src="@{/images/default-dieta.png}" alt="Dieta">

                <div class="page-card-body">
                    <h4 th:text="${d.tipoDieta}"></h4>
                    <p th:text="${d.descripcion}"></p>

                    <small class="text-muted d-block">üêæ Mascota: <span th:text="${d.nombreMascota}"></span></small>
                    <small class="text-muted d-block">üë©‚Äç‚öïÔ∏è Vet.: Dr. <span th:text="${d.nombreVeterinario}"></span></small>
                    <small class="text-success fw-bold d-block mt-1">En curso</small>

                    <div class="mt-3 mb-3">
                        <small class="d-block"><strong>Inicio:</strong> <span th:text="${#temporals.format(d.fechaInicio, 'dd/MM/yyyy')}"></span></small>
                        <small class="d-block"><strong>Fin:</strong> <span th:text="${#temporals.format(d.fechaFin, 'dd/MM/yyyy')}"></span></small>
                    </div>

                    <div class="mt-auto">
                        <button class="btn btn-primary btn-sm w-100 mb-2"
                                data-bs-toggle="modal"
                                data-bs-target="#modalCalendarioDieta"
                                th:data-dieta-id="${d.idDieta}"
                                th:data-fecha-inicio="${d.fechaInicio}"
                                th:data-fecha-fin="${d.fechaFin}"
                                th:data-dieta-nombre="${d.tipoDieta}">
                            <i class="fas fa-calendar-alt"></i> Ver Calendario
                        </button>

                        <button class="btn btn-danger btn-sm w-100 btn-terminar-directo"
                                th:data-id="${d.idDieta}">
                            <i class="fas fa-check-circle"></i> Terminar Dieta
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="tab-pane fade" id="historial" role="tabpanel">
        <div class="page-cards-container">
            <div th:if="${#lists.isEmpty(historial)}" class="alert alert-secondary w-50 text-center mt-4">
                No tienes dietas en el historial.
            </div>

            <div th:unless="${#lists.isEmpty(historial)}" th:each="h : ${historial}" class="page-card card-finished">
                <span class="badge-finished">Finalizada</span>

                <img th:if="${h.foto != null}" th:src="@{/uploads/dietas/{foto}(foto=${h.foto})}" alt="Dieta">
                <img th:if="${h.foto == null}" th:src="@{/images/default-dieta.png}" alt="Dieta">

                <div class="page-card-body">
                    <h4 th:text="${h.tipoDieta}"></h4>
                    <p th:text="${h.descripcion}"></p>

                    <small class="text-muted d-block">üêæ Mascota: <span th:text="${h.nombreMascota}"></span></small>
                    <small class="text-muted d-block">üë©‚Äç‚öïÔ∏è Vet.: Dr. <span th:text="${h.nombreVeterinario}"></span></small>

                    <small class="text-muted d-block mt-2">Finaliz√≥ el: <span th:text="${#temporals.format(h.fechaFin, 'dd/MM/yyyy')}"></span></small>

                    <div class="mt-auto">
                        <button class="btn btn-secondary btn-sm w-100"
                                data-bs-toggle="modal"
                                data-bs-target="#modalCalendarioDieta"
                                th:data-dieta-id="${h.idDieta}"
                                th:data-fecha-inicio="${h.fechaInicio}"
                                th:data-fecha-fin="${h.fechaFin}"
                                th:data-dieta-nombre="${h.tipoDieta}">
                            <i class="fas fa-eye"></i> Ver Notas Hist√≥ricas
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="container mt-5 mb-5">
    <hr>
    <h3 class="text-center mb-4 text-muted">Calendario General</h3>
    <div id="calendar" style="height: 500px;"></div>
</div>

<footer class="footer mt-5">...</footer>

<div class="modal fade" id="eventModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">Agregar Nota General</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Fecha seleccionada: <span id="eventDateDisplay"></span></p>
                <input type="text" id="eventTitle" class="form-control" placeholder="Escribe tu nota aqu√≠">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" id="saveEventBtn">Guardar</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="successModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-sm">
        <div class="modal-content bg-success text-white text-center p-3">
            <p class="m-0">¬°Nota guardada!</p>
        </div>
    </div>
</div>

<div class="modal fade" id="modalCalendarioDieta" tabindex="-1" aria-labelledby="calendarioDietaLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="calendarioDietaLabel">Calendario de Dieta</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i>
                    Haz clic en un d√≠a para a√±adir una nota de alimentaci√≥n.
                </div>
                <div id="dieta-calendar-instance"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>


<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.10.1/main.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/js/all.min.js"></script>
<script th:src="@{/js/citas.js}"></script>

<script>
    document.addEventListener("DOMContentLoaded", function () {

        /* ----------------------------------------------------------
           1. BOT√ìN "TERMINAR DIETA" (Directo en la tarjeta)
        ---------------------------------------------------------- */
        const botonesTerminar = document.querySelectorAll('.btn-terminar-directo');

        botonesTerminar.forEach(boton => {
            boton.addEventListener('click', async function() {
                // Confirmaci√≥n
                if (!confirm("¬øEst√°s seguro de marcar esta dieta como terminada? \nPasar√° a la pesta√±a de Historial.")) {
                    return;
                }

                try {
                    const id = this.getAttribute('data-id');
                    const resp = await fetch(`/dieta/terminar/${id}`, {
                        method: "POST"
                    });

                    if (resp.ok) {
                        alert("¬°Dieta terminada con √©xito!");
                        location.reload(); // Recargar para ver el cambio
                    } else {
                        try {
                            const data = await resp.json();
                            alert(data.error || "Error al terminar la dieta");
                        } catch(e) {
                            alert("Error al terminar la dieta.");
                        }
                    }
                } catch (err) {
                    alert("Error de conexi√≥n: " + err.message);
                }
            });
        });


        /* ----------------------------------------------------------
           2. CALENDARIO GENERAL (Global)
        ---------------------------------------------------------- */
        const calendarEl = document.getElementById("calendar");
        let selectedDate = null;
        const todayGlobal = new Date().toISOString().split('T')[0];

        if (calendarEl) {
            const calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: "dayGridMonth",
                locale: "es",
                selectable: true,
                headerToolbar: {
                    left: "prev,next today",
                    center: "title",
                    right: "dayGridMonth,timeGridWeek"
                },
                validRange: { start: todayGlobal },
                dateClick: function (info) {
                    if (info.dateStr < todayGlobal) {
                        alert("No puedes programar notas en fechas pasadas.");
                        return;
                    }
                    selectedDate = info.dateStr;
                    document.getElementById("eventDateDisplay").innerText = info.dateStr;
                    new bootstrap.Modal(document.getElementById("eventModal")).show();
                }
            });
            calendar.render();

            document.getElementById("saveEventBtn").addEventListener("click", function () {
                const eventTitle = document.getElementById("eventTitle").value.trim();
                if (eventTitle) {
                    calendar.addEvent({ title: eventTitle, start: selectedDate, allDay: true });
                    bootstrap.Modal.getInstance(document.getElementById("eventModal")).hide();
                    document.getElementById("eventTitle").value = "";
                    const successModal = new bootstrap.Modal(document.getElementById("successModal"));
                    successModal.show();
                    setTimeout(() => successModal.hide(), 1500);
                } else {
                    alert("Ingrese una nota v√°lida.");
                }
            });
        }


        /* ----------------------------------------------------------
           3. CALENDARIO INDIVIDUAL (Modal)
        ---------------------------------------------------------- */
        const modalCalendarioDietaEl = document.getElementById("modalCalendarioDieta");
        const calendarInstanceEl = document.getElementById("dieta-calendar-instance");
        const modalTitle = document.getElementById("calendarioDietaLabel");
        let dietaCalendar = null;

        modalCalendarioDietaEl.addEventListener("shown.bs.modal", function (event) {

            const button = event.relatedTarget;
            if (!button) return;

            const dietaId = button.getAttribute("data-dieta-id");
            const fechaInicio = button.getAttribute("data-fecha-inicio");
            const fechaFin = button.getAttribute("data-fecha-fin");
            const dietaNombre = button.getAttribute("data-dieta-nombre");

            modalTitle.textContent = `Calendario de: ${dietaNombre}`;

            if (dietaCalendar) dietaCalendar.destroy();

            let fechaFinExclusiva = null;
            if(fechaFin){
                let d = new Date(fechaFin); d.setDate(d.getDate() + 1);
                fechaFinExclusiva = d.toISOString().split("T")[0];
            }

            const eventosGuardados = JSON.parse(localStorage.getItem(`dietaEvents_${dietaId}`) || "[]");

            dietaCalendar = new FullCalendar.Calendar(calendarInstanceEl, {
                initialView: "dayGridMonth",
                locale: "es",
                height: '100%',
                headerToolbar: { left: "prev,next", center: "title", right: "today" },
                validRange: { start: fechaInicio, end: fechaFinExclusiva },
                events: eventosGuardados,

                dateClick: function (info) {
                    // Bloquear edici√≥n si es una dieta terminada (bot√≥n secundario gris)
                    if(button.classList.contains('btn-secondary')) {
                        alert("Esta dieta ya termin√≥, solo puedes ver las notas.");
                        return;
                    }

                    const nota = prompt("Registro alimentaci√≥n:");
                    if (nota && nota.trim() !== "") {
                        const newEvent = {
                            title: nota,
                            start: info.dateStr,
                            allDay: true,
                            color: '#198754' // Verde para dietas
                        };
                        dietaCalendar.addEvent(newEvent);
                        guardarEventos(dietaId, dietaCalendar);
                    }
                },
                eventClick: function (info) {
                    if(button.classList.contains('btn-secondary')) return;

                    if (confirm("¬øEliminar esta nota?")) {
                        info.event.remove();
                        guardarEventos(dietaId, dietaCalendar);
                    }
                }
            });
            dietaCalendar.render();
        });

        function guardarEventos(id, cal) {
            const events = cal.getEvents().map(e => ({ title: e.title, start: e.startStr, color: '#198754' }));
            localStorage.setItem(`dietaEvents_${id}`, JSON.stringify(events));
        }
    });
</script>

</body>
</html>