<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SCM - Consulta de Actividad</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" th:href="@{/css/stilos.css}">
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@5.10.1/main.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <style>
        .page-cards-container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            justify-content: center;
            margin-top: 30px;
        }
        .page-card {
            width: 300px;
            border: 1px solid #ddd;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            background: white;
        }
        .page-card img {
            width: 100%;
            height: 200px;
            object-fit: cover;
        }
        .page-card-body {
            padding: 15px;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }
        .mt-auto { margin-top: auto; }
        #actividad-calendar-instance { min-height: 400px; max-height: 60vh; }

        /* --- ESTILOS PARA LAS TERMINADAS --- */
        .card-finished {
            border: 2px solid #ccc;
            background-color: #f8f9fa;
            opacity: 0.9;
        }
        .card-finished .page-card-body {
            color: #6c757d;
        }
        .card-finished img {
            filter: grayscale(80%);
        }
        .badge-finished {
            position: absolute;
            top: 10px;
            right: 10px;
            background-color: #6c757d;
            color: white;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: bold;
        }
    </style>
</head>
<body>

<div th:replace="~{fragments/menuV :: menuV}"></div>
<input type="checkbox" id="btn-menu">
<div th:replace="~{fragments/barralateralD :: barralateralD(${diagnosticoDTO}, ${mascotas}, ${veterinarios}, ${usuario})}"></div>
<div th:replace="~{fragments/barralateralD :: modalDiagnostico(${diagnosticoDTO}, ${mascotas}, ${veterinarios})}"></div>


<div class="container text-center mt-5">
    <h1 class="header-title">Actividades de la Mascota</h1>
    <p class="lead">Gestiona y consulta el historial de ejercicios</p>
</div>

<div class="container mt-3 text-center">
    <a th:href="@{/dueno/mascotas}" class="btn btn-secondary">
        ‚Üê Volver a Mis Mascotas
    </a>
</div>

<div class="container mt-4">
    <ul class="nav nav-tabs justify-content-center" id="myTab" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active fw-bold" id="activas-tab" data-bs-toggle="tab" data-bs-target="#activas" type="button" role="tab">
                <i class="fas fa-running text-primary"></i> En Curso (Activas)
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link fw-bold text-secondary" id="historial-tab" data-bs-toggle="tab" data-bs-target="#historial" type="button" role="tab">
                <i class="fas fa-history"></i> Historial (Terminadas)
            </button>
        </li>
    </ul>
</div>

<div class="tab-content" id="myTabContent">

    <div class="tab-pane fade show active" id="activas" role="tabpanel">
        <div class="page-cards-container">
            <div th:if="${#lists.isEmpty(actividades)}" class="alert alert-info w-50 text-center mt-4">
                No hay actividades activas actualmente.
            </div>

            <div th:unless="${#lists.isEmpty(actividades)}" th:each="a : ${actividades}" class="page-card">
                <img th:if="${a.foto != null}" th:src="@{/uploads/actividades/{foto}(foto=${a.foto})}" alt="Actividad">
                <img th:if="${a.foto == null}" th:src="@{/images/default-activity.png}" alt="Actividad">

                <div class="page-card-body">
                    <h4 th:text="${a.tipoActividad}"></h4>
                    <p th:text="${a.descripcion}"></p>

                    <small class="text-muted d-block">üêæ Mascota: <span th:text="${a.nombreMascota}"></span></small>
                    <small class="text-muted d-block">üë©‚Äç‚öïÔ∏è Vet.: Dr. <span th:text="${a.nombreVeterinario}"></span></small>
                    <small class="text-primary fw-bold d-block mt-1">En curso</small>

                    <div class="mt-3 mb-3">
                        <small class="d-block"><strong>Inicio:</strong> <span th:text="${#temporals.format(a.fechaInicio, 'dd/MM/yyyy')}"></span></small>
                        <small class="d-block"><strong>Fin:</strong> <span th:text="${#temporals.format(a.fechaFin, 'dd/MM/yyyy')}"></span></small>
                    </div>

                    <div class="mt-auto">
                        <button class="btn btn-primary btn-sm w-100 mb-2"
                                data-bs-toggle="modal" data-bs-target="#modalCalendarioActividad"
                                th:data-actividad-id="${a.idActividadFisica}"
                                th:data-fecha-inicio="${a.fechaInicio}" th:data-fecha-fin="${a.fechaFin}"
                                th:data-actividad-nombre="${a.tipoActividad}">
                            <i class="fas fa-calendar-alt"></i> Calendario
                        </button>
                        <button class="btn btn-danger btn-sm w-100 btn-terminar-directo" th:data-id="${a.idActividadFisica}">
                            <i class="fas fa-check-circle"></i> Terminar Actividad
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="tab-pane fade" id="historial" role="tabpanel">
        <div class="page-cards-container">
            <div th:if="${#lists.isEmpty(historial)}" class="alert alert-secondary w-50 text-center mt-4">
                No tienes actividades terminadas en el historial.
            </div>

            <div th:unless="${#lists.isEmpty(historial)}" th:each="h : ${historial}" class="page-card card-finished">
                <span class="badge-finished">Finalizada</span>

                <img th:if="${h.foto != null}" th:src="@{/uploads/actividades/{foto}(foto=${h.foto})}" alt="Actividad">
                <img th:if="${h.foto == null}" th:src="@{/images/default-activity.png}" alt="Actividad">

                <div class="page-card-body">
                    <h4 th:text="${h.tipoActividad}"></h4>
                    <p th:text="${h.descripcion}"></p>

                    <small class="text-muted d-block">üêæ Mascota: <span th:text="${h.nombreMascota}"></span></small>
                    <small class="text-muted d-block">üë©‚Äç‚öïÔ∏è Vet.: Dr. <span th:text="${h.nombreVeterinario}"></span></small>

                    <small class="text-muted d-block mt-2">Finaliz√≥ el: <span th:text="${#temporals.format(h.fechaFin, 'dd/MM/yyyy')}"></span></small>

                    <div class="mt-auto">
                        <button class="btn btn-secondary btn-sm w-100"
                                data-bs-toggle="modal" data-bs-target="#modalCalendarioActividad"
                                th:data-actividad-id="${h.idActividadFisica}"
                                th:data-fecha-inicio="${h.fechaInicio}" th:data-fecha-fin="${h.fechaFin}"
                                th:data-actividad-nombre="${h.tipoActividad}">
                            <i class="fas fa-eye"></i> Ver Historial Notas
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

</div>

<div class="container mt-5 mb-5">
    <hr>
    <h3 class="text-center mb-4 text-muted">Calendario General de Notas</h3>
    <div id="calendar" style="height: 500px;"></div>
</div>

<footer class="footer mt-5">...</footer>


<div class="modal fade" id="modalCalendarioActividad" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="calendarioActividadLabel">Calendario</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>
            <div class="modal-body">
                <div id="actividad-calendar-instance"></div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="eventModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">Agregar Nota General</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Fecha seleccionada: <span id="eventDateDisplay"></span></p>
                <input type="text" id="eventTitle" class="form-control" placeholder="Escribe tu nota aqu√≠">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" id="saveEventBtn">Guardar</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="successModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-sm">
        <div class="modal-content bg-success text-white text-center p-3">
            <p class="m-0">¬°Nota guardada!</p>
        </div>
    </div>
</div>


<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.10.1/main.min.js"></script>
<script th:src="@{/js/citas.js}"></script>

<script>
    document.addEventListener("DOMContentLoaded", function () {

        /* ----------------------------------------------------------
           1. BOT√ìN TERMINAR ACTIVIDAD
        ---------------------------------------------------------- */
        const botonesTerminar = document.querySelectorAll('.btn-terminar-directo');
        botonesTerminar.forEach(boton => {
            boton.addEventListener('click', async function() {
                if (!confirm("¬øFinalizar actividad? Se mover√° a la pesta√±a Historial.")) return;
                try {
                    const resp = await fetch(`/actividad/terminar/${this.getAttribute('data-id')}`, { method: "POST" });
                    if (resp.ok) location.reload();
                    else alert("Error al terminar.");
                } catch (err) { alert("Error de conexi√≥n."); }
            });
        });

        /* ----------------------------------------------------------
           2. CALENDARIO DE LA MODAL (ACTIVIDAD INDIVIDUAL)
        ---------------------------------------------------------- */
        const modalEl = document.getElementById("modalCalendarioActividad");
        const calendarEl = document.getElementById("actividad-calendar-instance");
        let calendar = null;

        modalEl.addEventListener("shown.bs.modal", function (event) {
            const btn = event.relatedTarget;
            const id = btn.getAttribute("data-actividad-id");
            const start = btn.getAttribute("data-fecha-inicio");
            const end = btn.getAttribute("data-fecha-fin");

            if (calendar) calendar.destroy();

            let fechaFinExclusiva = null;
            if(end){
                 let d = new Date(end); d.setDate(d.getDate() + 1);
                 fechaFinExclusiva = d.toISOString().split("T")[0];
            }

            const events = JSON.parse(localStorage.getItem(`actividadEvents_${id}`) || "[]");

            calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: "dayGridMonth",
                locale: "es",
                height: '100%',
                headerToolbar: { left: "prev,next", center: "title", right: "today" },
                validRange: { start: start, end: fechaFinExclusiva },
                events: events,
                dateClick: function(info) {
                    if(btn.classList.contains('btn-secondary')) {
                        alert("No puedes agregar notas a una actividad terminada.");
                        return;
                    }
                    let n = prompt("Nota:");
                    if(n) {
                        calendar.addEvent({title:n, start:info.dateStr, allDay:true, color:'#28a745'});
                        guardar(id, calendar);
                    }
                }
            });
            calendar.render();
        });

        function guardar(id, cal) {
            const ev = cal.getEvents().map(e => ({title:e.title, start:e.startStr, color:'#28a745'}));
            localStorage.setItem(`actividadEvents_${id}`, JSON.stringify(ev));
        }


        /* ----------------------------------------------------------
           3. RESTAURADO: CALENDARIO GENERAL (EL GRANDE DE ABAJO)
        ---------------------------------------------------------- */
        const generalCalendarEl = document.getElementById("calendar");
        let selectedDate = null;
        const todayGlobal = new Date().toISOString().split('T')[0];

        if (generalCalendarEl) {
            const generalCalendar = new FullCalendar.Calendar(generalCalendarEl, {
                initialView: "dayGridMonth",
                locale: "es",
                selectable: true,
                editable: false,
                headerToolbar: {
                    left: "prev,next today",
                    center: "title",
                    right: "dayGridMonth,timeGridWeek,timeGridDay"
                },
                validRange: { start: todayGlobal },
                dateClick: function (info) {
                    if (info.dateStr < todayGlobal) {
                        alert("No puedes programar notas en fechas pasadas.");
                        return;
                    }
                    selectedDate = info.dateStr;
                    document.getElementById("eventDateDisplay").innerText = info.dateStr;
                    new bootstrap.Modal(document.getElementById("eventModal")).show();
                }
            });

            generalCalendar.render();

            // Funcionalidad del Modal General
            document.getElementById("saveEventBtn").addEventListener("click", function () {
                const eventTitle = document.getElementById("eventTitle").value.trim();
                if (eventTitle) {
                    generalCalendar.addEvent({
                        title: eventTitle,
                        start: selectedDate,
                        allDay: true
                    });
                    bootstrap.Modal.getInstance(document.getElementById("eventModal")).hide();
                    document.getElementById("eventTitle").value = "";
                    const successModal = new bootstrap.Modal(document.getElementById("successModal"));
                    successModal.show();
                    setTimeout(() => successModal.hide(), 1500);
                } else {
                    alert("Ingrese una nota v√°lida.");
                }
            });
        }
    });
</script>

</body>
</html>