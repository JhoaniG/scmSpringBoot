<!-- src/main/resources/templates/fragments/barralateralV.html -->

<!-- ===========================
     BARRA LATERAL
=========================== -->
<div th:fragment="barralateralD(diagnosticoDTO, mascotas, veterinarios, usuario)" class="container-menu p-3">
    <div class="cont-menu">
        <label for="btn-menu" class="d-block mb-2">✖️</label>

        <!-- Tarjeta de usuario -->
        <div class="card text-center mb-3">
            <img th:if="${usuario != null and usuario.foto != null}"
                 th:src="@{'/uploads/' + ${usuario.foto}}"
                 alt="Foto de perfil"
                 class="rounded-circle mb-2"
                 style="width:100px;height:100px;object-fit:cover;">
            <h4 th:text="${usuario.nombre} + ' ' + ${usuario.apellido}">Nombre Apellido</h4>
            <p th:text="${usuario.email}">correo@example.com</p>

            <h5>
                <span th:switch="${usuario.rol.rol}">
                    <span th:case="'Administrador'">Administrador</span>
                    <span th:case="'duenoMascota'">Dueño de Mascota</span>
                    <span th:case="'Veterinario'">Veterinario</span>
                    <span th:case="*">Desconocido</span>
                </span>
            </h5>

            <a th:href="@{/usuario/editar}" class="btn btn-primary btn-sm mt-2">Editar perfil</a>
        </div>

        <!-- Menú de navegación -->
        <ul class="nav flex-column">
            <li class="nav-item mb-1">
                <a class="nav-link btn btn-outline-primary w-100"
                   href="#" data-bs-toggle="modal" data-bs-target="#diagnosticoModal">
                    Registrar Diagnóstico
                </a>
            </li>
            <li class="nav-item mb-1">
                <a class="nav-link btn btn-outline-primary w-100" th:href="@{/duenoMascota/listar}">Consultar Citas</a>
            </li>
            <li class="nav-item mb-1">
                <a class="nav-link btn btn-outline-primary w-100" th:href="@{/dueno/mascotas/actividad}">Consultar Actividad Física</a>
            </li>
            <li class="nav-item mb-1">
                <a class="nav-link btn btn-outline-primary w-100" th:href="@{/dueno/mascotas}">Consultar Dieta</a>
            </li>

            <!-- Dropdown Mascotas -->
            <li class="nav-item dropdown mt-2">
                <button class="btn btn-outline-secondary w-100 dropdown-toggle"
                        type="button" id="dropdownMascotas"
                        data-bs-toggle="dropdown" aria-expanded="false">
                    Mascotas
                </button>
                <ul class="dropdown-menu w-100" aria-labelledby="dropdownMascotas">
                    <li><a class="dropdown-item" th:href="@{/mascotas/listar}">Mis mascotas</a></li>
                    <li><a class="dropdown-item" th:href="@{/mascotas/crear}">Agregar Mascota</a></li>
                </ul>
            </li>

            <!-- Logout -->
            <li class="nav-item mt-3">
                <form th:action="@{/logout}" method="post">
                    <button type="submit" class="btn btn-danger w-100">Cerrar sesión</button>
                </form>
            </li>
        </ul>
    </div>
</div>

<!-- ===========================
     MODAL REGISTRAR DIAGNÓSTICO
=========================== -->
<div th:fragment="modalDiagnostico(diagnosticoDTO, mascotas, veterinarios)">
    <div class="modal fade" id="diagnosticoModal" tabindex="-1" aria-labelledby="diagnosticoModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content shadow-lg border-0 rounded-4">
                <form th:object="${diagnosticoDTO}" th:action="@{/diagnosticos/crear}" method="post" class="needs-validation" novalidate>
                    <div class="modal-header bg-primary text-white rounded-top-4">
                        <h5 class="modal-title fw-bold" id="diagnosticoModalLabel">Registrar Reporte de Síntomas</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>

                    <div class="modal-body bg-light">
                        <input type="hidden" th:field="*{idDiagnosticoDueno}" />

                        <div class="mb-3">
                            <label for="mascotaId" class="form-label">Mascota</label>
                            <select th:field="*{mascotaId}" id="mascotaId" class="form-select" required>
                                <option value="" disabled selected>Seleccione una mascota</option>
                                <option th:each="m : ${mascotas}" th:value="${m.idMascota}" th:text="${m.nombre}"></option>
                            </select>
                            <div class="invalid-feedback">Seleccione una mascota.</div>
                        </div>

                        <div class="mb-3">
                            <label for="tipoEnfermedadSelect" class="form-label fw-semibold">Tipo de Enfermedad</label>
                            <select th:field="*{tipoEnfermedad}" id="tipoEnfermedadSelect" class="form-select" required>
                                <option value="" disabled selected>Seleccione el tipo de problema...</option>
                                <option value="Problemas Digestivos / Nutricionales">Problemas Digestivos / Nutricionales</option>
                                <option value="Problemas Ortopédicos / Movilidad">Problemas Ortopédicos / Movilidad</option>
                                <option value="Problemas de Comportamiento">Problemas de Comportamiento</option>
                                <option value="Condición General / Otro">Condición General / Otro</option>
                            </select>
                            <div class="invalid-feedback">Seleccione el tipo de problema.</div>
                        </div>

                        <div class="mb-3">
                            <label for="veterinarioSelect" class="form-label">Veterinario</label>
                            <select th:field="*{veterinarioId}" id="veterinarioSelect" class="form-select" required disabled>
                                <option value="" disabled selected>Seleccione un tipo de enfermedad primero...</option>
                            </select>
                            <div class="invalid-feedback">Seleccione un veterinario.</div>
                        </div>
                        <div class="mb-3">
                        <label for="fechaDiagnostico" class="form-label">Fecha del Reporte</label>
                        <input type="date" th:field="*{fechaDiagnostico}" id="fechaDiagnostico" class="form-control" readonly>
                        <div class="form-text">La fecha se asigna automáticamente.</div>
                    </div>
                        <div class="mb-3">
                            <label for="observaciones" class="form-label">Observaciones</label>
                            <textarea th:field="*{observaciones}" id="observaciones" class="form-control" rows="3" required minlength="10" maxlength="500" placeholder="Describa síntomas..."></textarea>
                            <div class="invalid-feedback">Ingrese observaciones (10-500 caracteres).</div>
                        </div>
                    </div>

                    <div class="modal-footer bg-white">
                        <button type="submit" class="btn btn-success">Guardar</button>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script th:inline="javascript">
        document.addEventListener('DOMContentLoaded', function() {

          const tipoEnfermedadSelect = document.getElementById('tipoEnfermedadSelect');
          const veterinarioSelect = document.getElementById('veterinarioSelect');

          // Función para cargar veterinarios
          async function cargarVeterinarios(tipoEnfermedad) {
            // Limpia y deshabilita el select de veterinarios mientras carga
            veterinarioSelect.innerHTML = '<option value="" disabled selected>Cargando especialistas...</option>';
            veterinarioSelect.disabled = true;

            try {
              // Llama a nuestro nuevo endpoint en el controlador
              const response = await fetch(`/api/veterinarios-por-tipo-enfermedad?tipoEnfermedad=${encodeURIComponent(tipoEnfermedad)}`);
              if (!response.ok) {
                throw new Error('Error al cargar veterinarios');
              }

              const veterinarios = await response.json();

              // Limpia el select
              veterinarioSelect.innerHTML = '<option value="" disabled selected>Seleccione un veterinario</option>';

              // Llena el select con las nuevas opciones
              veterinarios.forEach(v => {
                const option = document.createElement('option');
                option.value = v.idUsuario; // Corresponde al ID de veterinario
                option.textContent = `${v.nombre} (${v.especialidad})`;
                veterinarioSelect.appendChild(option);
              });

              // Habilita el select
              veterinarioSelect.disabled = false;

            } catch (error) {
              console.error('Error en fetch:', error);
              veterinarioSelect.innerHTML = '<option value="" disabled selected>Error al cargar</option>';
            }
          }

          // Añade el "listener" que detecta cambios
          tipoEnfermedadSelect.addEventListener('change', function() {
            const tipoSeleccionado = this.value;
            if (tipoSeleccionado) {
              cargarVeterinarios(tipoSeleccionado);
            } else {
              veterinarioSelect.innerHTML = '<option value="" disabled selected>Seleccione un tipo de enfermedad primero...</option>';
              veterinarioSelect.disabled = true;
            }
          });

          // Resetea el formulario cuando el modal se cierra
          const modal = document.getElementById('diagnosticoModal');
          modal.addEventListener('hidden.bs.modal', function () {
              tipoEnfermedadSelect.value = "";
              veterinarioSelect.innerHTML = '<option value="" disabled selected>Seleccione un tipo de enfermedad primero...</option>';
              veterinarioSelect.disabled = true;
              // Resetea el resto del formulario si es necesario
              modal.querySelector('form').classList.remove('was-validated');
              modal.querySelector('form').reset();
          });

        });
    </script>
</div>
