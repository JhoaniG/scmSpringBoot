<!-- src/main/resources/templates/fragments/barralateralV.html -->

<!-- ===========================
     BARRA LATERAL
=========================== -->
<div th:fragment="barralateralD(diagnosticoDTO, mascotas, veterinarios, usuario)" class="container-menu p-3">
    <div class="cont-menu">
        <label for="btn-menu" class="d-block mb-2">✖️</label>

        <!-- Tarjeta de usuario -->
        <div class="card text-center mb-3">
            <img th:if="${usuario != null and usuario.foto != null}"
                 th:src="@{'/uploads/' + ${usuario.foto}}"
                 alt="Foto de perfil"
                 class="rounded-circle mb-2"
                 style="width:100px;height:100px;object-fit:cover;">
            <h4 th:text="${usuario.nombre} + ' ' + ${usuario.apellido}">Nombre Apellido</h4>
            <p th:text="${usuario.email}">correo@example.com</p>

            <h5>
                <span th:switch="${usuario.rol.rol}">
                    <span th:case="'Administrador'">Administrador</span>
                    <span th:case="'duenoMascota'">Dueño de Mascota</span>
                    <span th:case="'Veterinario'">Veterinario</span>
                    <span th:case="*">Desconocido</span>
                </span>
            </h5>

            <a th:href="@{/usuario/editar}" class="btn btn-primary btn-sm mt-2">Editar perfil</a>
        </div>

        <!-- Menú de navegación -->
        <ul class="nav flex-column">
            <li class="nav-item mb-1">
                <a class="nav-link btn btn-outline-primary w-100"
                   href="#" data-bs-toggle="modal" data-bs-target="#diagnosticoModal">
                    Registrar Diagnóstico
                </a>
            </li>
            <li class="nav-item mb-1">
                <a class="nav-link btn btn-outline-primary w-100" th:href="@{/duenoMascota/listar}">Consultar Citas</a>
            </li>
            <li class="nav-item mb-1">
                <a class="nav-link btn btn-outline-primary w-100" th:href="@{/dueno/mascotas/actividad}">Consultar Actividad Física</a>
            </li>
            <li class="nav-item mb-1">
                <a class="nav-link btn btn-outline-primary w-100" th:href="@{/dueno/mascotas}">Consultar Dieta</a>
            </li>

            <!-- Dropdown Mascotas -->
            <li class="nav-item dropdown mt-2">
                <button class="btn btn-outline-secondary w-100 dropdown-toggle"
                        type="button" id="dropdownMascotas"
                        data-bs-toggle="dropdown" aria-expanded="false">
                    Mascotas
                </button>
                <ul class="dropdown-menu w-100" aria-labelledby="dropdownMascotas">
                    <li><a class="dropdown-item" th:href="@{/mascotas/listar}">Mis mascotas</a></li>
                    <li><a class="dropdown-item" th:href="@{/mascotas/crear}">Agregar Mascota</a></li>
                </ul>
            </li>

            <!-- Logout -->
            <li class="nav-item mt-3">
                <form th:action="@{/logout}" method="post">
                    <button type="submit" class="btn btn-danger w-100">Cerrar sesión</button>
                </form>
            </li>
        </ul>
    </div>
</div>

<!-- ===========================
     MODAL REGISTRAR DIAGNÓSTICO
=========================== -->
<div th:fragment="modalDiagnostico(diagnosticoDTO, mascotas, veterinarios)">
    <div class="modal fade" id="diagnosticoModal" tabindex="-1" aria-labelledby="diagnosticoModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content border-0 shadow-lg" style="border-radius: 20px; overflow: hidden;">

                <div class="modal-header text-white" style="background: linear-gradient(135deg, #6f42c1 0%, #a88beb 100%); padding: 1.5rem;">
                    <h5 class="modal-title fw-bold" id="diagnosticoModalLabel">
                        <i class="fas fa-notes-medical me-2"></i>Reportar Síntomas
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>

                <form th:object="${diagnosticoDTO}" th:action="@{/diagnosticos/crear}" method="post" class="needs-validation" novalidate>
                    <div class="modal-body p-4 bg-light">
                        <input type="hidden" th:field="*{idDiagnosticoDueno}" />

                        <div class="row g-3 mb-3">
                            <div class="col-md-6">
                                <label for="mascotaId" class="form-label fw-bold text-secondary small">
                                    <i class="fas fa-paw me-1"></i> PACIENTE
                                </label>
                                <select th:field="*{mascotaId}" id="mascotaId" class="form-select form-select-lg shadow-sm border-0" required>
                                    <option value="" disabled selected>Selecciona tu mascota...</option>
                                    <option th:each="m : ${mascotas}" th:value="${m.idMascota}" th:text="${m.nombre}"></option>
                                </select>
                                <div class="invalid-feedback">Seleccione una mascota.</div>
                            </div>
                            <div class="col-md-6">
                                <label for="fechaDiagnostico" class="form-label fw-bold text-secondary small">
                                    <i class="far fa-calendar-alt me-1"></i> FECHA
                                </label>
                                <input type="date" th:field="*{fechaDiagnostico}" id="fechaDiagnostico" class="form-control form-control-lg shadow-sm border-0 bg-white" readonly>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="tipoEnfermedadSelect" class="form-label fw-bold text-secondary small">
                                <i class="fas fa-heartbeat me-1"></i> SÍNTOMA PRINCIPAL
                            </label>
                            <select th:field="*{tipoEnfermedad}" id="tipoEnfermedadSelect" class="form-select form-select-lg shadow-sm border-0" required>
                                <option value="" disabled selected>¿Qué le pasa a tu mascota?</option>

                                <optgroup label="General">
                                    <option value="Consulta General / Chequeo">Consulta General / Chequeo</option>
                                    <option value="Vacunación / Desparasitación">Vacunación / Desparasitación</option>
                                </optgroup>

                                <optgroup label="Digestivo">
                                    <option value="Vómitos / Diarrea">Vómitos / Diarrea</option>
                                    <option value="Pérdida de Apetito">Pérdida de Apetito</option>
                                </optgroup>

                                <optgroup label="Piel y Pelaje">
                                    <option value="Problemas de Piel / Alergias">Problemas de Piel / Alergias</option>
                                    <option value="Caída de Pelo / Rasquiña">Caída de Pelo / Rasquiña</option>
                                </optgroup>

                                <optgroup label="Movilidad">
                                    <option value="Cojera / Dolor Articular">Cojera / Dolor Articular</option>
                                    <option value="Dificultad para Caminar">Dificultad para Caminar</option>
                                </optgroup>

                                <optgroup label="Comportamiento">
                                    <option value="Ansiedad / Agresividad">Ansiedad / Agresividad</option>
                                    <option value="Cambios de Conducta">Cambios de Conducta</option>
                                </optgroup>

                                <optgroup label="Otros">
                                    <option value="Problemas Respiratorios">Problemas Respiratorios (Tos/Gripe)</option>
                                    <option value="Problemas Oculares">Problemas en los Ojos</option>
                                    <option value="Otro / Urgencia">Otro / No estoy seguro</option>
                                </optgroup>
                            </select>
                            <div class="invalid-feedback">Seleccione el tipo de problema.</div>
                        </div>

                        <div class="mb-3">
                            <label for="veterinarioSelect" class="form-label fw-bold text-secondary small">
                                <i class="fas fa-user-md me-1"></i> ESPECIALISTA RECOMENDADO
                            </label>
                            <div class="input-group shadow-sm">
                                <span class="input-group-text bg-white border-0"><i class="fas fa-search text-muted"></i></span>
                                <select th:field="*{veterinarioId}" id="veterinarioSelect" class="form-select form-select-lg border-0" required disabled>
                                    <option value="" disabled selected>Elige un síntoma arriba primero...</option>
                                </select>
                            </div>
                            <div class="form-text text-muted ms-1">El sistema buscará al mejor especialista para el síntoma seleccionado.</div>
                        </div>

                        <div class="mb-3">
                            <label for="observaciones" class="form-label fw-bold text-secondary small">
                                <i class="fas fa-align-left me-1"></i> DETALLES ADICIONALES
                            </label>
                            <textarea th:field="*{observaciones}" id="observaciones" class="form-control shadow-sm border-0" rows="3"
                                      required minlength="10" maxlength="500" placeholder="Describe brevemente qué síntomas has notado..."></textarea>
                            <div class="invalid-feedback">Por favor, danos más detalles (mín. 10 caracteres).</div>
                        </div>
                    </div>

                    <div class="modal-footer border-top-0 bg-light pb-4 pe-4">
                        <button type="button" class="btn btn-link text-secondary text-decoration-none fw-bold" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn text-white fw-bold px-4 rounded-pill shadow-sm"
                                style="background: linear-gradient(135deg, #6f42c1 0%, #a88beb 100%); border: none;">
                            <i class="fas fa-paper-plane me-2"></i> Enviar Reporte
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script th:inline="javascript">
        document.addEventListener('DOMContentLoaded', function() {
          const tipoEnfermedadSelect = document.getElementById('tipoEnfermedadSelect');
          const veterinarioSelect = document.getElementById('veterinarioSelect');

          // Función para cargar veterinarios
          async function cargarVeterinarios(tipoEnfermedad) {
            veterinarioSelect.innerHTML = '<option value="" disabled selected>Buscando especialistas...</option>';
            veterinarioSelect.disabled = true;

            try {
              const response = await fetch(`/api/veterinarios-por-tipo-enfermedad?tipoEnfermedad=${encodeURIComponent(tipoEnfermedad)}`);
              if (!response.ok) throw new Error('Error al cargar veterinarios');
              const veterinarios = await response.json();

              veterinarioSelect.innerHTML = '<option value="" disabled selected>Seleccione un especialista disponible</option>';
              veterinarios.forEach(v => {
                const option = document.createElement('option');
                option.value = v.idUsuario;
                option.textContent = `${v.nombre} (${v.especialidad})`;
                veterinarioSelect.appendChild(option);
              });
              veterinarioSelect.disabled = false;
            } catch (error) {
              console.error(error);
              veterinarioSelect.innerHTML = '<option value="" disabled selected>Error de conexión</option>';
            }
          }

          tipoEnfermedadSelect.addEventListener('change', function() {
            const tipo = this.value;
            if (tipo) cargarVeterinarios(tipo);
            else {
                 veterinarioSelect.innerHTML = '<option value="" disabled selected>Elige un síntoma arriba primero...</option>';
                 veterinarioSelect.disabled = true;
            }
          });

          // Reset al cerrar
          const modal = document.getElementById('diagnosticoModal');
          modal.addEventListener('hidden.bs.modal', function () {
              tipoEnfermedadSelect.value = "";
              veterinarioSelect.innerHTML = '<option value="" disabled selected>Elige un síntoma arriba primero...</option>';
              veterinarioSelect.disabled = true;
              modal.querySelector('form').classList.remove('was-validated');
              modal.querySelector('form').reset();
          });
        });
    </script>
</div>