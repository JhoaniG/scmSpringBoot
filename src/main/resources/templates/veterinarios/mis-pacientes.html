<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Mis Pacientes</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" th:href="@{/css/stilos.css}">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet">
</head>
<body>
<div th:replace="~{fragments/menuV :: menuV}"></div>
<input type="checkbox" id="btn-menu">
<div th:replace="~{fragments/barralateralV :: barralateralV}"></div>

<div class="capa">
    <div class="container mt-5">
        <h2 class="text-center mb-4">Mis Pacientes</h2>

        <div class="card shadow-sm mb-4">
            <div class="card-body">
                <form th:action="@{/veterinario/mis-pacientes}" method="GET" class="d-flex">
                    <input class="form-control me-2" type="search"
                           placeholder="Buscar por nombre de mascota o dueño..."
                           name="filtro" th:value="${filtro}">

                    <button class="btn btn-primary me-2" type="submit">
                        <i class="fas fa-search"></i>
                    </button>

                    <a th:href="@{/veterinario/mis-pacientes}" class="btn btn-outline-secondary">
                        <i class="fas fa-times"></i>
                    </a>
                </form>
            </div>
        </div>

        <div class="table-responsive shadow-sm">
            <table class="table table-striped table-hover align-middle">
                <thead class="table-dark">
                <tr>
                    <th class="text-center">Foto</th>
                    <th>Nombre</th>
                    <th>Raza</th>
                    <th>Dueño</th>
                    <th class="text-center">Acciones</th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="paciente : ${pacientesPage.content}">
                    <td class="text-center">
                        <img th:src="@{'/uploads/mascotas/' + ${paciente.foto}}" alt="Foto de la mascota"
                             style="width: 60px; height: 60px; object-fit: cover; border-radius: 50%;">
                    </td>
                    <td th:text="${paciente.nombre}"></td>
                    <td th:text="${paciente.raza}"></td>
                    <td th:text="${paciente.usuario.nombre} + ' ' + ${paciente.usuario.apellido}"></td>
                    <td class="text-center">
                        <a th:href="@{/veterinario/mascotas/{id}(id=${paciente.idMascota})}" class="btn btn-info btn-sm" title="Ver Detalles">
                            <i class="fas fa-eye"></i>
                        </a>

                        <button type="button" class="btn btn-danger btn-sm btn-abrir-preview"
                                data-bs-toggle="modal"
                                data-bs-target="#previewPdfModal"
                                th:data-mascota-id="${paciente.idMascota}"
                                th:data-download-url="@{/veterinario/mascotas/{id}/historial/pdf(id=${paciente.idMascota})}">
                            <i class="fas fa-file-pdf"></i>
                        </button>
                    </td>
                </tr>
                <tr th:if="${pacientesPage.empty}">
                    <td colspan="5" class="text-center text-muted">No se encontraron pacientes que coincidan con la búsqueda.</td>
                </tr>
                </tbody>
            </table>
        </div>

        <nav aria-label="Paginacion" th:if="${pacientesPage.totalPages > 0}">
            <ul class="pagination justify-content-center mt-4">

                <li class="page-item" th:classappend="${pacientesPage.first} ? 'disabled'">
                    <a class="page-link" th:href="@{/veterinario/mis-pacientes(filtro=${filtro}, page=0, size=${pacientesPage.size})}">Primero</a>
                </li>
                <li class="page-item" th:classappend="${pacientesPage.first} ? 'disabled'">
                    <a class="page-link" th:href="@{/veterinario/mis-pacientes(filtro=${filtro}, page=${pacientesPage.number - 1}, size=${pacientesPage.size})}">Anterior</a>
                </li>

                <th:block th:with="
                    start=${T(java.lang.Math).max(0, pacientesPage.number - 2)},
                    end=${T(java.lang.Math).min(pacientesPage.totalPages - 1, pacientesPage.number + 2)}">

                    <li class="page-item" th:each="i : ${#numbers.sequence(start, end)}"
                        th:classappend="${i == pacientesPage.number} ? 'active'">
                        <a class="page-link" th:href="@{/veterinario/mis-pacientes(filtro=${filtro}, page=${i}, size=${pacientesPage.size})}" th:text="${i + 1}"></a>
                    </li>
                </th:block>

                <li class="page-item" th:classappend="${pacientesPage.last} ? 'disabled'">
                    <a class="page-link" th:href="@{/veterinario/mis-pacientes(filtro=${filtro}, page=${pacientesPage.number + 1}, size=${pacientesPage.size})}">Siguiente</a>
                </li>
                <li class="page-item" th:classappend="${pacientesPage.last} ? 'disabled'">
                    <a class="page-link" th:href="@{/veterinario/mis-pacientes(filtro=${filtro}, page=${pacientesPage.totalPages - 1}, size=${pacientesPage.size})}">Último</a>
                </li>
            </ul>
        </nav>

    </div>
</div>
<div class="modal fade" id="previewPdfModal" tabindex="-1" aria-labelledby="previewPdfModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable"> <div class="modal-content">
        <div class="modal-header bg-dark text-white">
            <h5 class="modal-title" id="previewPdfModalLabel">Vista Previa del Historial Clínico</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>

        <div class="modal-body" id="previewModalBody">
            <div id="preview-loading" class="text-center p-5">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Cargando...</span>
                </div>
                <p class="mt-2">Cargando vista previa...</p>
            </div>

            <div id="preview-content" style="display: none;">
            </div>
        </div>

        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>

            <a id="btn-confirmar-descarga" href="#" class="btn btn-danger" target="_blank" download>
                <i class="fas fa-file-pdf"></i> Confirmar y Descargar PDF
            </a>
        </div>
    </div>
    </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {

        const previewModal = document.getElementById('previewPdfModal');
        if (previewModal) {
            const loadingSpinner = document.getElementById('preview-loading');
            const contentDiv = document.getElementById('preview-content');
            const downloadButton = document.getElementById('btn-confirmar-descarga');

            // Escucha el evento "show.bs.modal" (cuando el modal se empieza a abrir)
            previewModal.addEventListener('show.bs.modal', async function (event) {
                // 1. Muestra el spinner y oculta el contenido
                loadingSpinner.style.display = 'block';
                contentDiv.style.display = 'none';
                contentDiv.innerHTML = ''; // Limpia el contenido anterior

                // 2. Obtiene los datos del botón que fue clickeado
                const button = event.relatedTarget;
                const mascotaId = button.getAttribute('data-mascota-id');
                const downloadUrl = button.getAttribute('data-download-url');

                // 3. Asigna la URL de descarga al botón del modal
                downloadButton.href = downloadUrl;

                try {
                    // 4. Llama a nuestra nueva API para obtener el HTML de vista previa
                    const response = await fetch(`/api/historial/preview/${mascotaId}`);

                    if (!response.ok) {
                        throw new Error('No se pudo cargar la vista previa.');
                    }

                    const htmlPreview = await response.text();

                    // 5. Inyecta el HTML en el modal
                    contentDiv.innerHTML = htmlPreview;

                    // 6. Oculta el spinner y muestra el contenido
                    loadingSpinner.style.display = 'none';
                    contentDiv.style.display = 'block';

                } catch (error) {
                    console.error(error);
                    loadingSpinner.innerHTML = '<p class="text-danger">Error al cargar la vista previa.</p>';
                }
            });
        }
    });
</script>
</body>
</html>